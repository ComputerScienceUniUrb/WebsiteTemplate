/* 
 * Author: Andriy Fedosyeyeev
 * e-mail: a@fedosev.com
 *
 */

var fed_slider=function(x,u,g){var c=jQuery;if(c(x).length){g=c.extend({},{cols:6,rows:4,margin:8,duration:400,interval:5E3,play:!0,effect:"slide2",text_effect:"text_transition_1",alwaysGrid:!1,selectors:{text:"#fed_slider_text",prev:".fed-this.prev",next:".fed-this.next",play:".fed-play",pause:".fed-play"}},g);var D=g.width||parseInt(c(x).css("width")),v=g.margin,e=g.cols,m=g.rows,r=(D-v*(e-1))/e,w=e*m,B=g.duration,y=0,n=[],h=[],z=g.selectors.text,C=null,A=!1,z=g.selectors.text+"_",f=0,q=0;this.init=
function(){c.each(u,function(d){c(x).css("width",(r+v)*e-v);c(x).css("height",(r+v)*m-v);c(x).append('<div id="fed_slider_'+d+'"></div>');"link"in u[d]&&u[d].link&&c("#fed_slider_"+d).addClass("link").click(function(){window.location=u[d].link});k=1;for(j=0;j<m;j++)for(i=0;i<e;i++)txtClass=txt="",c("#fed_slider_"+d).append('<div class="d_'+k+""+txtClass+'">'+txt+"</div>"),l=(r+v)*i,t=(r+v)*j,c("#fed_slider_"+d+" .d_"+k).css({left:l,top:t,backgroundPosition:"-"+l+"px -"+t+"px",width:r,height:r,backgroundImage:"url("+
u[d].src+")"}),k++;"random"in u[d]&&(rnd=Math.floor(Math.random()*w)+1,c("#fed_slider_"+d+" .d_"+rnd).addClass("text").append(u[d].random))})};this.exchange=function(d,f){for(k=0;k<w;k++)h[k]=!1;for(i=0;i<m;i++)for(j=0;j<e;j++)if(!1==h[i*e+j]){stop=!1;for(ii=0;ii<m&&!stop;ii++)for(jj=0;jj<e&&!stop;jj++)n[i][j]==n[ii][jj]&&!(i==ii&&j==jj)&&(h[ii*e+jj]=!0,stop=h[i*e+j]=!0,pos1=i*e+j+1,pos2=ii*e+jj+1,a=c("#fed_slider_"+d+" .d_"+pos1).position(),b=c("#fed_slider_"+d+" .d_"+pos2).position(),
c("#fed_slider_"+d+" .d_"+pos1).animate({left:b.left,top:b.top},{queue:!0,duration:f}),c("#fed_slider_"+d+" .d_"+pos2).animate({left:a.left,top:a.top},{queue:!0,duration:f}))}};this.genmat=function(){for(k=0;k<w;k++)h[k]=!1;k=0;a=[];for(i=0;i<m;i++)for(j=0;j<e;j++){p=0;for(l=1;l<e-j;l++)a[p]=l,p++;for(l=1;l<m-i;l++)a[p]=0-l,p++;for(;p<e+m-2;p++)a[p]=0;a.sort(function(d,c){return Math.abs(d)-Math.abs(c)});a1=a.slice(0,Math.floor(0.75*a.length));a2=a.slice(Math.floor(0.75*a.length),a.length);a1.sort(function(d,
c){return 0.5-Math.round(Math.random())});a=a1.concat(a2);s=!1;for(l=0;l<e+m-2&&!s;l++)0<a[l]?!1==h[i*e+j+a[l]]&&!1==h[i*e+j]&&(h[i*e+j+a[l]]=!0,h[i*e+j]=!0,n[i][j]=k,n[i][j+a[l]]=k,s=!0,k++):0>a[l]&&(!1==h[(i+Math.abs(a[l]))*e+j]&&!1==h[i*e+j])&&(h[(i+Math.abs(a[l]))*e+j]=!0,h[i*e+j]=!0,n[i][j]=k,n[i+Math.abs(a[l])][j]=k,s=!0,k++)}};this.genmat2=function(){for(i=0;i<m;i++)n[i]=[];tt=0;for(ss=!0;!0==ss;){k=0;a=[];for(k=0;k<w;k++)h[k]=!1;for(i=0;i<m;i++)for(j=0;j<e;j++)n[i][j]=i*m+j;tt++;ss=!1;for(i=
0;i<m&&!ss;i++)for(j=0;j<e&&!ss;j++){p=0;for(l=1;l<e-j;l++)a[p]=l,p++;for(l=1;l<m-i;l++)a[p]=0-l,p++;for(;p<e+m-2;p++)a[p]=0;a.sort(function(d,c){return Math.abs(d)-Math.abs(c)});a1=a.slice(0,Math.floor(0.75*a.length));a2=a.slice(Math.floor(0.75*a.length),a.length);a1.sort(function(c,e){return 0.5-Math.round(Math.random())});a=a1.concat(a2);s=!1;for(l=0;l<e+m-2&&!s;l++)0<a[l]?!1==h[i*e+j+a[l]]&&!1==h[i*e+j]&&(0<i&&40>=w&&n[i-1][j]==n[i-1][j+a[l]]&&(ss=!0),i<m-1&&40>=w&&n[i+1][j]==n[i+1][j+a[l]]&&
(ss=!0),ss||(h[i*e+j+a[l]]=!0,h[i*e+j]=!0,n[i][j]=k,n[i][j+a[l]]=k,s=!0,k++)):0>a[l]&&(!1==h[(i+Math.abs(a[l]))*e+j]&&!1==h[i*e+j])&&(0<j&&40>=w&&n[i][j-1]==n[i+Math.abs(a[l])][j-1]&&(ss=!0),j<e-1&&40>=w&&n[i][j+1]==n[i+Math.abs(a[l])][j+1]&&(ss=!0),ss||(h[(i+Math.abs(a[l]))*e+j]=!0,h[i*e+j]=!0,n[i][j]=k,n[i+Math.abs(a[l])][j]=k,s=!0,k++))}}};this.grid=function(d,f,g){for(i=0;i<m-1;i++)for(j=0;j<e-1;j++)p=i*e+j+1,c(x+" #fed_slider_"+d+" .d_"+p).animate({width:g?r:Math.ceil(r)+v,height:g?
r:Math.ceil(r)+v},{queue:!0,duration:f});for(i=0;i<e-1;i++)p=(m-1)*e+i+1,c(x+" #fed_slider_"+d+" .d_"+p).animate({width:g?r:Math.ceil(r)+v},{queue:!0,duration:f});for(i=0;i<m;i++)p=i*e,c(x+" #fed_slider_"+d+" .d_"+p).animate({height:g?r:Math.ceil(r)+v},{queue:!0,duration:f})};this.reset_timer=function(){A&&(this.pause(),this.play())};this.play=function(){A=!0;C=setInterval(c.proxy(this.next,this),g.interval)};this.pause=function(){A=!1;clearInterval(C)};this.isPlay=function(){return A};this.next=
function(){this.unbind_click();this.reset_timer();this.genmat2();q=f;f=f<u.length-1?f+1:0;this.reset();1<u.length&&(eval("this."+g.effect+"("+B+")"),g.selectors.text&&eval("this."+g.text_effect+"("+B+")"))};this.prev=function(){this.unbind_click();this.reset_timer();this.genmat2();q=f;f=0<f?f-1:u.length-1;this.reset();1<u.length&&(this.slide4(B),g.selectors.text&&eval("this."+g.text_effect+"("+0.55*B+")"))};this.reset=function(){c("#fed_slider_"+f).fadeTo(0,1);for(i=0;i<u.length;i++)i!=q&&i!=f&&(c("#fed_slider_"+
i+" div, #fed_slider_"+i).css("z-index","100"),c("#fed_slider_"+i+" div").fadeTo(0,0.01),c("#fed_slider_"+i).fadeTo(0,0))};this.zindex=function(){c("#fed_slider_"+q+" div, #fed_slider_"+q).css("z-index","101");c("#fed_slider_"+f+" div, #fed_slider_"+f).css("z-index","102")};this.slide1=function(d){this.exchange(f,0);this.zindex();c("#fed_slider_"+f+" div").fadeTo(0,1);this.exchange(f,d)};this.slide2=function(d){this.exchange(f,0);c("#fed_slider_"+f+" div").fadeTo(0.75*d,1);c("#fed_slider_"+q+" div").fadeTo(0.75*
d,0.01,c.proxy(function(){++y==w&&(y=0,this.zindex(),this.exchange(f,d))},this));setTimeout(c.proxy(this.bind_click,this),2.4*d)};this.slide3=function(d){this.exchange(f,0);c("#fed_slider_"+f+" div").fadeTo(d,1);c("#fed_slider_"+q+" div").fadeTo(d,0.01,function(){++y==w&&(y=0,this.zindex())});this.exchange(f,d);c("#fed_slider_"+f+" div").dequeue()};this.slide4=function(d){this.exchange(f,0);this.exchange(f,d);this.exchange(q,d);c("#fed_slider_"+f+" div").fadeTo(d,1);c("#fed_slider_"+q+" div").fadeTo(d,
0.01,c.proxy(function(){++y==w&&(y=0,this.zindex(),this.exchange(q,0))},this));c("#fed_slider_"+f+" div").dequeue();c("#fed_slider_"+q+" div").dequeue();setTimeout(c.proxy(this.bind_click,this),1.4*d)};this.slide5=function(d){this.grid(q,0.4*d,!0);this.grid(f,0.4*d,!0);setTimeout(c.proxy(function(){this.slide2(d)},this),0.4*d+100);setTimeout(c.proxy(function(){this.grid(q,0.4*d,!1);this.grid(f,0.4*d,!1)},this),1.4*d+200);setTimeout(c.proxy(this.bind_click,this),2.4*d)};this.slide6=function(d){this.grid(q,
0.4*d,!0);this.grid(f,0.4*d,!0);setTimeout(c.proxy(function(){this.slide4(d)},this),0.4*d+100);setTimeout(c.proxy(function(){this.grid(q,0.4*d,!1);this.grid(f,0.4*d,!1)},this),1.4*d+200)};this.text_transition_1=function(d){setTimeout(function(){c(z+q+" h2").fadeTo(0.75*d,0.01,c.proxy(function(){},this));c(z+q+" p").fadeTo(0.75*d,0.01,c.proxy(function(){},this));c(z+f+" h2").fadeTo(0.75*d,1);c(z+f+" p").fadeTo(0.75*d,1)},1.6*d)};this.initText=function(){c(g.selectors.text+" .hidden *").css({display:"none"});
c(g.selectors.text+" .hidden p").css({position:"absolute"});c(g.selectors.text+" > div").css({display:"block"});c(g.selectors.text+" > div").css({width:290})};this.bind_click=function(){c(g.selectors.prev).bind("click",c.proxy(this.prev,this));c(g.selectors.next).bind("click",c.proxy(this.next,this))};this.unbind_click=function(){c(g.selectors.prev).unbind("click");c(g.selectors.next).unbind("click")};this.init();this.genmat2();this.reset();this.zindex();this.initText();this.bind_click();g.selectors.play==
g.selectors.pause&&c(g.selectors.play).bind("click",c.proxy(function(){A?this.pause():this.play()},this));g.play&&this.play()}};
